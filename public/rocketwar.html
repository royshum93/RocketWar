<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Rocket War</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
	<script type="text/javascript" src="weapon.js"></script>
    <style type="text/css">
        body {
            margin-top: 20px;
            margin-left: auto;
            margin-right: auto;
            width: 900px;
            background: #484848;
            overflow: hidden;
        }
    </style>
</head>

<body>
<script type="text/javascript">

var game = new Phaser.Game(900, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('bullet10', 'assets/bullet10.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    game.load.spritesheet('dude2', 'assets/dude2.png', 32, 48);
}

var player;
var otherPlayer;

var platforms;
var cursors;
var p1Weapons = [];
var p2Weapons = [];

var rocketDirection;
var rocketLRDirection;
var score = 0;
var score2 = 0;
var scoreText;
var scoreText2;

var timer;
var timerText;
var gameStatus = "ended";
var gameMessage;

function create() {
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    game.add.sprite(0, 0, 'sky');

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;    

    // Here we create the ground.
    var ground = platforms.create(0, game.world.height - 32, 'ground');

    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    ground.scale.setTo(2, 2);

    //  This stops it from falling away when you jump on it
    ground.body.immovable = true;

    //  Now let's create two ledges
    var ledge = platforms.create(750, 400, 'ground');
    ledge.body.immovable = true;

    ledge = platforms.create(-300, 400, 'ground');
    ledge.body.immovable = true;

    // middle one
    var middleLedge = platforms.create(340, 536, 'ground');
    middleLedge.scale.setTo(0.5, 1);
    middleLedge.body.immovable = true;

    // ledges in the air
    var airLedge = platforms.create(220, 250, 'ground');
    airLedge.body.immovable = true;
    var smallLedge = platforms.create(429, 218, 'ground');
    smallLedge.scale.setTo(0.08, 1);
    smallLedge.body.immovable = true;

    // walls
    var leftWall = platforms.create(0, 0, 'ground');
    leftWall.scale.setTo(0.03, 18);
    leftWall.body.immovable = true;

    var rightWall = platforms.create(887, 0, 'ground');
    rightWall.scale.setTo(0.03, 18);
    rightWall.body.immovable = true;

    // upper wall
    var upperWall = platforms.create(0, 0, 'ground');
    upperWall.scale.setTo(2, 0.5);
    upperWall.body.immovable = true;

    // The players and their postiions
    // random horizontal position when reborn
    var p1xPostion = game.rnd.integerInRange(12, 858);
    var p2xPostion = game.rnd.integerInRange(12, 858);

    player = game.add.sprite(p1xPostion, game.world.height - 550, 'dude');
    otherPlayer = game.add.sprite(p2xPostion, game.world.height - 550, 'dude2');

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);
    game.physics.arcade.enable(otherPlayer);
    game.physics.arcade.enable(p1Weapons);

    player.body.bounce.y = 0;
    player.body.gravity.y = 250;
    otherPlayer.body.bounce.y = 0;
    otherPlayer.body.gravity.y = 250;
    player.body.collideWorldBounds = true;
    otherPlayer.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);
    player.faceDirection = "right";

    otherPlayer.animations.add('left', [0, 1, 2, 3], 10, true);
    otherPlayer.animations.add('right', [5, 6, 7, 8], 10, true);

    //  The score
    scoreText = game.add.text(32, 32, 'Player 1 Score: 0', { fontSize: '18px', fill: '#FFF' });
    scoreText2 = game.add.text(700, 32, 'Player 2 Score: 0', { fontSize: '18px', fill: '#FFF' });

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();

    // p1Weapons
    p1Weapons.push(new Weapon.Rockets(this.game));
    p2Weapons.push(new Weapon.Rockets(this.game));

    // timer
    timerText = game.add.text(408, 28, '03:00', { fontSize: '32px', fill: '#FFF', align: 'center'});
    
    timer = game.time.create();
    // Create a delayed event 3m from now
    timerEvent = timer.add(Phaser.Timer.MINUTE * 3, endTimer, this);        
    // Start the timer
    timer.start();
    gameStatus = "playing";
}

function update() {
    //  Collide the player and the stars with the platforms
    game.physics.arcade.collide(player, platforms);
    game.physics.arcade.collide(otherPlayer, platforms);
    game.physics.arcade.collide(platforms, p1Weapons);

    //  Checks to see if the player overlaps with any of the rocket
    game.physics.arcade.overlap(otherPlayer, p1Weapons, weaponCollideOtherPlayer, null, this);

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;

    if (cursors.left.isDown && gameStatus != "ended") {
        //  Move to the left
        player.body.velocity.x = -150;

        player.animations.play('left');

        player.faceDirection = "left";
    }
    else if (cursors.right.isDown && gameStatus != "ended") {
        // Move to the right
        player.body.velocity.x = 150;

        player.animations.play('right');

        player.faceDirection = "right";
    }
    else {
        // Stand still
        player.animations.stop();

        if(player.faceDirection == "left")
            player.frame = 0;
        else if(player.faceDirection == "right")
            player.frame = 5;

        rocketLRDirection = "none";
    }

    // control rocket directions
    if(cursors.up.isDown) {
        rocketDirection = "up";
    }
    else if(cursors.down.isDown) {
        rocketDirection = "down";
    }
    else {
        rocketDirection = "none";
    }
    
    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown && player.body.touching.down  && gameStatus != "ended") {
        player.body.velocity.y = -350;
    }

    // fire
    if(this.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)  && gameStatus != "ended") {
        if(player.alive)
        	p1Weapons[0].fire(player);
    }

   	if (timer.running) {
        timerText.setText(formatTime(Math.round((timerEvent.delay - timer.ms) / 1000)));
    }
    else {
    	gameMessage = game.add.text(264, 245, "Press Space to Restart!", { fontSize: '32px', fill: '#FFF', align: 'center'});
    }

    // when game ended and press space
    if(this.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)  && gameStatus == "ended")
    	restartGame();
}

function formatTime(s) {
	// Convert seconds (s) to a nicely formatted and padded time string
    var minutes = "0" + Math.floor(s / 60);
    var seconds = "0" + (s - minutes * 60);
    return minutes.substr(-2) + ":" + seconds.substr(-2); 
}

function endTimer() {
	timer.stop();
	gameStatus = "ended";
}

function weaponCollideOtherPlayer (otherPlayer, p1Weapons) {
    // Removes the rocket from the screen
    p1Weapons.kill();
    otherPlayer.kill();

    // timer for player to reborn
    var p2RebornTimer = game.time.events.add(Phaser.Timer.SECOND * 1, p2Reborn, this);

    //  Add and update the score
    score += 1;
    scoreText.text = 'Player 1 Score: ' + score;
}

function weaponCollidePlayer (player, p1Weapons) {
    // Removes the rocket from the screen
    p1Weapons.kill();
    player.kill();

    // timer for player to reborn
    var p1RebornTimer = game.time.events.add(Phaser.Timer.SECOND * 1, p1Reborn, this);

    //  Add and update the score
    score2 += 1;
    scoreText2.text = 'Player 2 Score: ' + score2;
}

function p1Reborn() {
	var randomXPosition = game.rnd.integerInRange(12, 858);
	player.reset(randomXPosition, game.world.height - 550);
}

function p2Reborn() {
	var randomXPosition = game.rnd.integerInRange(12, 858);
	otherPlayer.reset(randomXPosition, game.world.height - 550);
}

function restartGame() {
	// not yet done
}

</script>
</body>
</html>
